<!DOCTYPE html>
<html lang="pt_BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Cropper.js</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="crooper/cropper.css">



    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.2.0/mdb.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: rgb(0, 0, 0);
            color: aliceblue;
           


        }

        h1 {
            color: aliceblue;
        }

        label {
            color: rgb(135, 135, 135);
        }

        .label {
            cursor: pointer;

        }

        .progress {
            display: none;
            margin-bottom: 1rem;
        }

        .alert {
            display: none;
        }

        .img-container img {
            max-width: 100%;

        }



        .container,
        .container-fluid,
        .container-lg,
        .container-md,
        .container-sm,
        .container-xl {
            width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
           
        }

        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
            }).on('hidden.bs.modal', function () {
                cropper.destroy();
                cropper = null;
            });

            document.getElementById('crop').addEventListener('click', function () {
                var initialAvatarURL;
                var canvas;

                $modal.modal('hide');

                if (cropper) {
                    canvas = cropper.getCroppedCanvas({
                        width: 160,
                        height: 160,
                    });

                    initialAvatarURL = avatar.src;
                    avatar.src = canvas.toDataURL();
                    $progress.hide();
                    $alert.removeClass('alert-success alert-warning');
                    canvas.toBlob(function (blob) {
                        var formData = new FormData();

                        formData.append('avatar', blob, 'avatar.jpg');


                        firebase
                            .database()
                            .ref(`${pegaA}/bday`)
                            .push(

                                {
                                    aprovado: false,
                                    apelido: 'apelido'

                                }
                            ).once('value', (snap) => {
                                var idVal = snap.val()
                                var idFoto = snap.Key


                                console.log(`id foto é ${snap.key}`)

                                const anoAtual = new Date().getFullYear()


                                const base64 = avatar.src.split('base64,')[1]
                                firebase.storage().ref(`bday${anoAtual}/${snap.key}.png`).putString(base64, 'base64', { contentType: 'image/png' }).then(snapshot => {
                                    console.log('snapshot', snapshot)

                                    firebase.storage().ref(`bday${anoAtual}/${snap.key}.png`).getDownloadURL().then(url => {
                                        console.log('endereço', url)


                                        var apelido = document.getElementById('apelido').value
                                        var nome = document.getElementById('nome').value
                                        var data = document.getElementById('data').value
                                        var whats = document.getElementById('whats').value

                                        var promo1 = "Com 15 convidados pagantes até 2H o aniversariante ganha 1 garrafa de Vodka Smirnoff ou Gin Nacional"
                                       

                                        firebase.database()
                                            .ref(`${pegaA}/bday/${snap.key}`)
                                            .set(

                                                
                                                {
                                                    foto: url,
                                                    aprovado: false,
                                                    apelido: 'B-day ' + apelido,
                                                    nome: nome,
                                                    data: data,
                                                    whats: whats,
                                                    status: 'Aniversariante',
                                                    regra: promo1

                                                }
                                            )
                                        
                                        window.open(`${parentURL}?p=${pegaA}/bday/${snap.key}`, '_top')

                                    })

                                })


                            })




                            .then(() => {
                                console.log('Foi Gravado')
                            
                            

                                document.getElementById('mApelido').innerHTML = apelido.value





                            })
                            .catch(error => {
                                console.error('Hi fodeu!: ', error)
                            })










                    });
                }
            });
        });





    </script>

  


</body>



</html>
